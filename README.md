# Scripthub (LoxBerry Plugin)

A lightweight **script runner + scheduler** for LoxBerry.
Browse your scripts, view/edit safely, run them manually (nohup), or schedule them via cron — all from a clean web UI.

> Supports shell (`.sh`), Python (`.py`), PHP (`.php`), and any executable file in the configured folder.

## Table of Contents

- [Scripthub (LoxBerry Plugin)](#scripthub-loxberry-plugin)
  - [Table of Contents](#table-of-contents)
  - [Features](#features)
  - [Screenshots](#screenshots)
  - [Installation](#installation)
  - [Defaults](#defaults)
  - [Usage](#usage)
    - [Add scripts](#add-scripts)
    - [Manual mode](#manual-mode)
    - [Scheduled (cron) mode](#scheduled-cron-mode)
    - [Settings](#settings)
  - [Cron details](#cron-details)
  - [Permissions \& sudo](#permissions--sudo)
  - [Troubleshooting](#troubleshooting)
  - [Development notes](#development-notes)
  - [Contributing](#contributing)
  - [License](#license)

## Features

* **Script Overview**

  * Auto-discovers scripts in a configurable directory.
  * Shows **Status** (Running/Offline), **Mode** (Manual/Scheduled), **Last Updated**, **Last Run**.
  * **View** read-only source with **Edit → Save/Cancel** toggle (backup on save).

* **Manual execution**

  * **Start/Stop** a script in the background (nohup). Output is appended to the plugin log.
  * **Run once** trigger (disabled when already running).

* **Cron scheduling**

  * Per-script **Cron** panel with quick-pick macros (`@hourly`, `@daily`, `*/5 * * * *`, etc.).
  * Mutually exclusive: **Manual (nohup)** *or* **Scheduled (cron)**.
  * Writes a single cron file (configurable, default `/etc/cron.d/scripthub`) with:

    * `flock` locking per script (no overlaps).
    * ISO timestamps and clear markers in the log:

      * `YYYY-MM-DDTHH:MM:SS === Started (cron) <script> ===`
      * `YYYY-MM-DDTHH:MM:SS --- Finished (cron) <script> (rc=N) ---`
      * `YYYY-MM-DDTHH:MM:SS --- Skipped (locked) <script> ---`

* **Settings page**

  * Paths: **Script directory**, **Log file**, **Lock directory**, **Cron preview**, **Cron target**.
  * **Cron file editor**: View-only first, then **Edit → Save/Cancel** (reloads cron on save; falls back to preview if no permission).
  * Maintenance actions: **Apply/Repair cron**, **Repair permissions**, **Create “Hello world” test script**, **Rotate log**.

* **Safety**

  * CSRF protection on all POST actions.
  * Path validation prevents editing outside the script directory.
  * File updates create timestamped backups: `<script>.YYYYMMDD_HHMMSS.bkp`.
  * Configurable **cron user** (default `loxberry`).

## Screenshots

> Replace with your own screenshots in `docs/`.

```md
![Overview](docs/overview.png)
![Cron](docs/cron.png)
![Settings](docs/settings.png)
```

## Installation

1. Install via the LoxBerry Plugin Manager **or** copy this plugin folder to your LoxBerry and install from ZIP.
2. Open the plugin UI and visit **Settings** to adjust paths if needed.

## Defaults

* Script directory: `/opt/loxberry/data/plugins/scripthub`
* Log file: `/opt/loxberry/data/plugins/scripthub/scripthub_cron.log`
* Lock directory: `/opt/loxberry/data/plugins/scripthub/locks`
* Cron preview: `/opt/loxberry/data/plugins/scripthub/scripthub.cron.preview`
* Cron target: `/etc/cron.d/scripthub`
* Cron user: `loxberry`

> The plugin tries a direct write to the cron target. If that fails, it attempts `sudo cp/chmod/chown`. If both fail, it writes the **preview** file so you can copy it manually.

## Usage

### Add scripts

Place `.sh`, `.py`, `.php` (or any executable) into the **Script directory**.
For non-extension executables, ensure they are executable:

```bash
chmod +x /path/to/script
```

### Manual mode

* **Start** to nohup the script (logs to the plugin log).
* **Stop** to kill the running process (matched by path).
* **Run once** to trigger a one-shot run (disabled if already running).

### Scheduled (cron) mode

* Click **Cron** → choose an expression or macro → **Save Schedule**.
* The script switches to **Scheduled** mode (Start/Stop disabled).
* To revert to manual, click **Disable Cron**.

### Settings

* Adjust paths and the cron user.
* **Apply/Repair cron** regenerates and reloads the cron file from your schedules.
* Use the **Cron file editor** to inspect or tweak the cron file; **Edit → Save** reloads cron automatically.

## Cron details

The plugin writes a single cron file (by default `/etc/cron.d/scripthub`) with environment headers and one line per scheduled script. Example:

```cron
# Generated by Scripthub
MAILTO=""
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

*/5 * * * * loxberry /usr/bin/flock -n "/opt/loxberry/data/plugins/scripthub/locks/scripthub.my_job.py.lock" -c 'echo "$(date -Iseconds) === Started (cron) my_job.py ===" >> "/opt/loxberry/data/plugins/scripthub/scripthub_cron.log"; /usr/bin/python3 "/opt/loxberry/data/plugins/scripthub/my_job.py" >> "/opt/loxberry/data/plugins/scripthub/scripthub_cron.log" 2>&1; rc=$?; echo "$(date -Iseconds) --- Finished (cron) my_job.py (rc=$rc) ---" >> "/opt/loxberry/data/plugins/scripthub/scripthub_cron.log"; exit $rc' || echo "$(date -Iseconds) --- Skipped (locked) my_job.py ---" >> "/opt/loxberry/data/plugins/scripthub/scripthub_cron.log"
```

Notes:

* **Username column** is mandatory in `/etc/cron.d/*` files (here: `loxberry`).
* ISO timestamps (`date -Iseconds`) avoid `%` escaping issues in crontab lines.
* `flock -n` ensures no overlapping runs by using per-script lock files in the **Lock directory**.
* The plugin automatically reloads cron after applying changes.

## Permissions & sudo

To let the plugin update `/etc/cron.d/scripthub` when a direct write isn’t permitted, add a minimal sudoers snippet:

```text
# /etc/sudoers.d/scripthub  (validate with: sudo visudo -cf /etc/sudoers.d/scripthub)
Cmnd_Alias SCRIPTHUB_CMDS = /bin/cp, /bin/chmod, /bin/chown, /usr/bin/systemctl reload cron, /usr/sbin/service cron reload
%loxberry ALL=(root) NOPASSWD: SCRIPTHUB_CMDS
```

Also ensure:

```bash
sudo chown root:root /etc/cron.d/scripthub
sudo chmod 644 /etc/cron.d/scripthub
```

The **Lock directory** should be writable by `loxberry` (plugin creates and `chmod 0777` best-effort).
The **Log file** is created/touched and `chmod 0666` best-effort.

## Troubleshooting

* **No runs appear in the log**

  * Reload cron:

    ```bash
    sudo systemctl reload cron || sudo service cron reload
    ```
  * Verify the cron file has a **trailing newline** and **username column**.
  * Check cron logs (Debian/Ubuntu):

    ```bash
    sudo journalctl -u cron --since "15 min ago"
    sudo grep CRON /var/log/syslog | tail -n 100
    ```
  * Ensure lock dir and log file exist & are writable by `loxberry`.
  * If editing cron manually, avoid raw `%` in commands (use `date -Iseconds` or escape `%` as `\%`).

* **“Last Run: Unknown”**

  * Ensure your script produced Start/Finished markers in the plugin log.
  * The parser supports both `YYYY-MM-DD HH:MM:SS` and ISO `YYYY-MM-DDTHH:MM:SS±TZ`.

* **“Could not write cron target” flash**

  * Check `/etc/sudoers.d/scripthub` (see snippet above).
  * Use the **preview** file and copy it manually:

    ```bash
    sudo cp /opt/loxberry/data/plugins/scripthub/scripthub.cron.preview /etc/cron.d/scripthub
    sudo chmod 644 /etc/cron.d/scripthub
    sudo chown root:root /etc/cron.d/scripthub
    sudo systemctl reload cron || sudo service cron reload
    ```

## Development notes

* PHP pages use `loxberry_web.php` / `loxberry_system.php`.
* Shared helpers live in `settings.inc.php`.
* State (modes/schedules) is stored in `scripthub.json` in the data directory.
* Settings are stored in `settings.json` in the data directory.

## Contributing

PRs and issues are welcome! Please include environment details (LoxBerry version, cron service) and repro steps.

## License

MIT — see `LICENSE` (or change to your preferred license).
